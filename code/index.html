<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Philip Park">
        <link rel="canonical" href="https://jhpark555.github.io/newdocu/code/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Code Review - OpenRISC MiddleWare Libraries</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-36723568-3', 'mkdocs.org');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">OpenRISC MiddleWare Libraries</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">Introduction</a>
                    </li>
                    <li class="active">
                        <a href="./">Code Review</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="..">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li class="disabled">
                        <a rel="prev" >
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/jhpark555/newdocu/edit/master/docs/code.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#0cpu-type-archcpuh">0.CPU type ( Arch/cpu.h )</a></li>
        <li class="main "><a href="#1linker-scripts">1.Linker Scripts</a></li>
        <li class="main "><a href="#2freertosconfigh">2.FreeRTOSConfig.h</a></li>
        <li class="main "><a href="#3portc">3.Port.c</a></li>
        <li class="main "><a href="#4mbedtls-configuration">4.Mbedtls Configuration</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="0cpu-type-archcpuh">0.CPU type ( Arch/cpu.h )</h2>
<pre><code>#define BYTE_ORDER BIG_ENDIAN
</code></pre>
<h2 id="1linker-scripts">1.Linker Scripts</h2>
<pre><code>MEMORY
{
    /* Put all sections expect data, rodata into ram2   */
    /* On ORSoC dev board devices, for pages 132-134 ( 256Bytes pages)  */

    vectors : ORIGIN = 0x00000000, LENGTH = 0x00002000
    sdram (rwx)    : ORIGIN = 0x00002000, LENGTH = 0x13500
    sdram2 (rwx)    : ORIGIN = 0x13500, LENGTH = 0x02000000 
}

heap_size = 10*1024;
SECTIONS
{
    .vectors :
    {
        _vec_start = .;
        *(.vectors)
        _vec_end = .;
    } &gt; vectors


    .text  :
    {
        . = ALIGN(4);
        *(.text)
        *(.text*)
        . = ALIGN(4);
    } &gt; sdram2

    .data  :
    {
        . = ALIGN(4);
        _dst_beg = .;
        *(.data)
        *(.data*)
        _dst_end = .;
        . = ALIGN(4);
    } &gt; sdram

    .rodata :
    {
        . = ALIGN(4);
        *(.rodata)
        *(.rodata.*)
        . = ALIGN(4);
    } &gt; sdram

    .sbss  :
    {
        . = ALIGN(4);
        _sbss_beg = .;
        *(.bss)
        *(.bss*)
        _sbss_end = .;
        . = ALIGN(4);
    } &gt; sdram2

    .sdata : {
        _gp = . + 0x800;
        *(.srodata.cst16) *(.srodata.cst8) *(.srodata.cst4) *(.srodata.cst2) *(.srodata*)
        *(.sdata .sdata.* .gnu.linkonce.s.*)
     }  &gt; sdram2

    .bss  :
    {
        . = ALIGN(4);
        _bss_beg = .;
        *(.bss)
        *(.bss*)
        *(COMMON)
        _bss_end = .;
        . = ALIGN(4);
    } &gt; sdram2

    .heap :
    {
        . = ALIGN(4);
        __heap_start = .;
        . = . +heap_size;
        __heap_end = .;
    } &gt; sdram2


    .stack :
    {
        . = ALIGN(4);
        *(.stack)
        _stack_top = .;
        . = ALIGN(4);
    } &gt;sdram2

    PROVIDE(_stack_top = 0x02000000 );
}
</code></pre>
<h2 id="2freertosconfigh">2.FreeRTOSConfig.h</h2>
<pre><code>#include "board.h"

#define configUSE_PREEMPTION            1
#define configUSE_IDLE_HOOK             0
#define configUSE_TICK_HOOK             0
#define configCPU_CLOCK_HZ              ( ( unsigned long ) SYS_CLK )
#define configTICK_RATE_HZ              ( ( TickType_t ) 1000 )
#define configMINIMAL_STACK_SIZE        ( ( unsigned short ) 100)
#define configTOTAL_HEAP_SIZE           ( ( size_t ) 49*1024 )
</code></pre>
<h2 id="3portc">3.Port.c</h2>
<pre><code>/*
 * Initialise the stack of a task to look exactly as if a call to
 * portSAVE_CONTEXT had been called. Context layout is described in
 * portmarco.h
 *
 * See header file for description.
 */
StackType_t *pxPortInitialiseStack( StackType_t *pxTopOfStack,
                                       TaskFunction_t pxCode,
                                       void *pvParameters )
{
    unsigned portLONG uTaskSR = mfspr(SPR_SR);

    // Supervisor mode
    uTaskSR |= SPR_SR_SM;
    // Tick interrupt enable, All External interupt enable
    uTaskSR |= (SPR_SR_TEE | SPR_SR_IEE);

    // allocate redzone
    pxTopOfStack -= REDZONE_SIZE/4;

    /* Setup the initial stack of the task.  The stack is set exactly as
    expected by the portRESTORE_CONTEXT() macro. */
    *(--pxTopOfStack) = ( StackType_t )pxCode;         // SPR_EPCR_BASE(0)
    *(--pxTopOfStack) = ( StackType_t )uTaskSR;        // SPR_ESR_BASE(0)

    *(--pxTopOfStack) = ( StackType_t )0x00000031;     // r31
    *(--pxTopOfStack) = ( StackType_t )0x00000030;     // r30
    *(--pxTopOfStack) = ( StackType_t )0x00000029;     // r29
    *(--pxTopOfStack) = ( StackType_t )0x00000028;     // r28
    *(--pxTopOfStack) = ( StackType_t )0x00000027;     // r27
    *(--pxTopOfStack) = ( StackType_t )0x00000026;     // r26
    *(--pxTopOfStack) = ( StackType_t )0x00000025;     // r25
    *(--pxTopOfStack) = ( StackType_t )0x00000024;     // r24
    *(--pxTopOfStack) = ( StackType_t )0x00000023;     // r23
    *(--pxTopOfStack) = ( StackType_t )0x00000022;     // r22
    *(--pxTopOfStack) = ( StackType_t )0x00000021;     // r21
    *(--pxTopOfStack) = ( StackType_t )0x00000020;     // r20
    *(--pxTopOfStack) = ( StackType_t )0x00000019;     // r19
    *(--pxTopOfStack) = ( StackType_t )0x00000018;     // r18
    *(--pxTopOfStack) = ( StackType_t )0x00000017;     // r17
    *(--pxTopOfStack) = ( StackType_t )0x00000016;     // r16
    *(--pxTopOfStack) = ( StackType_t )0x00000015;     // r15
    *(--pxTopOfStack) = ( StackType_t )0x00000014;     // r14
    *(--pxTopOfStack) = ( StackType_t )0x00000013;     // r13
    *(--pxTopOfStack) = ( StackType_t )0x00000012;     // r12
    *(--pxTopOfStack) = ( StackType_t )0x00000011;     // r11
    *(--pxTopOfStack) = ( StackType_t )0x00000010;     // r10
    *(--pxTopOfStack) = ( StackType_t )0x00000008;     // r8
    *(--pxTopOfStack) = ( StackType_t )0x00000007;     // r7
    *(--pxTopOfStack) = ( StackType_t )0x00000006;     // r6
    *(--pxTopOfStack) = ( StackType_t )0x00000005;     // r5
    *(--pxTopOfStack) = ( StackType_t )0x00000004;     // r4
    *(--pxTopOfStack) = ( StackType_t )pvParameters;   // task argument
    *(--pxTopOfStack) = ( StackType_t )0x00000002;     // r2
    *(--pxTopOfStack) = ( StackType_t )pxCode;         // PC

    return pxTopOfStack;
}

BaseType_t xPortStartScheduler( void )
{
    if(setjmp((void *)jmpbuf) == 0) {
        /* Start the timer that generates the tick ISR.
     * Interrupts are disabled here already. */
        prvSetupTimerInterrupt();

        /* Start the first task. */
        asm volatile (
        " .global   pxCurrentTCB    \n\t"
        /*   restore stack pointer          */
        "   l.movhi r3, hi(pxCurrentTCB)        \n\t"
        "   l.ori   r3, r3, lo(pxCurrentTCB)    \n\t"
        "   l.lwz   r3, 0x0(r3)     \n\t"
        "   l.lwz   r1, 0x0(r3)     \n\t"
        /*   restore context                */
        "   l.lwz   r9,  0x00(r1)   \n\t"
        "   l.lwz   r2,  0x04(r1)   \n\t"
        "   l.lwz   r6,  0x14(r1)   \n\t"
        "   l.lwz   r7,  0x18(r1)   \n\t"
        "   l.lwz   r8,  0x1C(r1)   \n\t"
        "   l.lwz   r10, 0x20(r1)   \n\t"
        "   l.lwz   r11, 0x24(r1)   \n\t"
        "   l.lwz   r12, 0x28(r1)   \n\t"
        "   l.lwz   r13, 0x2C(r1)   \n\t"
        "   l.lwz   r14, 0x30(r1)   \n\t"
        "   l.lwz   r15, 0x34(r1)   \n\t"
        "   l.lwz   r16, 0x38(r1)   \n\t"
        "   l.lwz   r17, 0x3C(r1)   \n\t"
        "   l.lwz   r18, 0x40(r1)   \n\t"
        "   l.lwz   r19, 0x44(r1)   \n\t"
        "   l.lwz   r20, 0x48(r1)   \n\t"
        "   l.lwz   r21, 0x4C(r1)   \n\t"
        "   l.lwz   r22, 0x50(r1)   \n\t"
        "   l.lwz   r23, 0x54(r1)   \n\t"
        "   l.lwz   r24, 0x58(r1)   \n\t"
        "   l.lwz   r25, 0x5C(r1)   \n\t"
        "   l.lwz   r26, 0x60(r1)   \n\t"
        "   l.lwz   r27, 0x64(r1)   \n\t"
        "   l.lwz   r28, 0x68(r1)   \n\t"
        "   l.lwz   r29, 0x6C(r1)   \n\t"
        "   l.lwz   r30, 0x70(r1)   \n\t"
        "   l.lwz   r31, 0x74(r1)   \n\t"
        /*  restore SPR_ESR_BASE(0), SPR_EPCR_BASE(0) */
        "   l.lwz   r3,  0x78(r1)   \n\t"
        "   l.lwz   r4,  0x7C(r1)   \n\t"
        "   l.mtspr r0,  r3, %1     \n\t"
        "   l.mtspr r0,  r4, %2     \n\t"
        /*   restore clobber register     */
        "   l.lwz   r3,  0x08(r1)   \n\t"
        "   l.lwz   r4,  0x0C(r1)   \n\t"
        "   l.lwz   r5,  0x10(r1)   \n\t"
        "   l.addi  r1,  r1, %0     \n\t"
        "   l.rfe                   \n\t"
        "   l.nop                   \n\t"
        :
        :   "n"(STACKFRAME_SIZE),
            "n"(SPR_ESR_BASE),
            "n"(SPR_EPCR_BASE)
        );

        /* Should not get here! */
    } else {
        /* Retrun by vPortEndScheduler */
    }

    return 0;
}
</code></pre>
<h2 id="4mbedtls-configuration">4.Mbedtls Configuration</h2>
<pre><code>#define MBEDTLS_PLATFORM_CALLOC_MACRO mbedtls_calloc
#define MBEDTLS_PLATFORM_FREE_MACRO mbedtls_free
/*
 * Save RAM at the expense of interoperability: do this only if you control
 * both ends of the connection!  (See comments in "mbedtls/ssl.h".)
 * The optimal size here depends on the typical size of records.
 */
#define MBEDTLS_SSL_MAX_CONTENT_LEN             (5*1024)
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright & copy; 2018 Philip Park</p>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script src="../js/base.js"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
